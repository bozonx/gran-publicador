# Анализ концепции неактивных каналов

**Дата:** 2026-01-09  
**Статус:** Аналитический отчёт

## Содержание

1. [Обзор текущей реализации](#обзор-текущей-реализации)
2. [Сравнение с архивированием](#сравнение-с-архивированием)
3. [Необходимость функции](#необходимость-функции)
4. [Отображение в списках](#отображение-в-списках)
5. [Участие в сборе проблем](#участие-в-сборе-проблем)
6. [Подсчёт статистики](#подсчёт-статистики)
7. [Рекомендации](#рекомендации)

---

## Обзор текущей реализации

### Схема данных

В модели `Channel` есть поле:

```prisma
isActive Boolean @default(true) @map("is_active")
```

### Текущее поведение

1. **По умолчанию:** Все новые каналы создаются активными (`isActive: true`)
2. **Переключение:** Пользователь может включать/выключать активность канала через UI (функция `toggleChannelActive`)
3. **Влияние на публикацию:** Неактивные каналы **не могут публиковать** посты:
   - В `SocialPostingService.validateChannelReady()`:
     ```typescript
     if (!channel.isActive) errors.push('Channel is not active');
     ```
   - В `useSocialPosting.canPublishToChannel()`:
     ```typescript
     if (!channel.isActive) return false;
     ```

---

## Сравнение с архивированием

| Аспект | Неактивный канал (`isActive: false`) | Архивированный канал (`archivedAt: Date`) |
|--------|--------------------------------------|-------------------------------------------|
| **Цель** | Временная приостановка публикации | Долгосрочное хранение без использования |
| **Видимость в списках** | Виден в основных списках | Скрыт из основных списков (отдельный раздел архива) |
| **Публикация** | ❌ Заблокирована | ❌ Заблокирована |
| **Удаление** | Не требуется восстановление | Требуется разархивирование |
| **Визуальный индикатор** | Badge "Неактивен" (warning) | Отображается только в архиве |
| **Редактирование** | ✅ Разрешено | ✅ Разрешено |
| **Подсчёт в статистике** | ⚠️ Спорный момент (см. ниже) | ❌ Исключён |

### Ключевые различия

1. **Архивирование** — это "убрать с глаз долой". Канал больше не нужен, но данные сохраняются.
2. **Деактивация** — это "временная пауза". Канал может понадобиться позже, пользователь хочет держать его под рукой.

**Типичные сценарии использования неактивных каналов:**
- Сезонные каналы (например, только для новогодних акций)
- Каналы на модерации или проверке
- Каналы с истекающими/обновляемыми токенами
- Временно заблокированные каналы соц. сетью
- A/B тестирование контента (один канал активен, другой — нет)

---

## Необходимость функции

### ✅ Аргументы ЗА сохранение функции

1. **Гибкость управления** — быстро отключить без потери видимости
2. **Разный контекст** — архивирование = "не нужен", деактивация = "на паузе"
3. **Удобство workflow** — не нужно архивировать/разархивировать для временной паузы
4. **Индикация проблем** — неактивный канал виден в проблемах, можно не забыть его проверить

### ❌ Аргументы ПРОТИВ

1. **Путаница** — два способа "отключить" канал усложняют концепцию
2. **Дублирование** — функциональность частично пересекается
3. **Низкое использование** — большинство пользователей будут использовать либо одно, либо другое

### Вердикт: **Функция имеет смысл и должна остаться**

Неактивность и архивирование решают разные задачи. Однако необходимо чётко разграничить их поведение в UI и документации.

---

## Отображение в списках

### Текущая реализация

1. **Страница каналов (`/channels`):**
   - Неактивные каналы **видны** в общем списке
   - Есть фильтр по issue type = `inactive`
   - Есть визуальный badge "Неактивен"

2. **Dashboard панель каналов (`DashboardPanel.vue`):**
   ```typescript
   return channels.value.filter(c => c.isActive && !c.archivedAt)
   ```
   Неактивные каналы **исключены** из подсчёта активных каналов.

3. **Виджет проблем (`ProblemsWidget.vue`):**
   - Количество неактивных каналов **считается** и отображается как проблема (warning)

### Рекомендуемое поведение

| Контекст | Отображение неактивных каналов |
|----------|--------------------------------|
| Список каналов проекта | ✅ Видны, с индикатором |
| Общий список каналов | ✅ Видны, можно фильтровать |
| Dashboard панель каналов | ❌ Исключены из подсчёта |
| Виджет проблем | ✅ Показывать как warning |
| Форма создания поста | ✅ Видны, но disabled с пояснением |
| Выбор каналов для публикации | ⚠️ Видны, но помечены как недоступные |

---

## Участие в сборе проблем

### Текущая реализация

Неактивные каналы **участвуют** в сборе проблем:

```typescript
// useChannels.ts
function getChannelProblems(channel: any) {
    // ...
    if (channel.isActive !== undefined && !channel.isActive) {
        problems.push({ type: 'warning', key: 'inactiveChannel' })
    }
}
```

```typescript
// usePublications.ts
function hasChannelProblems(publication: PublicationWithRelations): boolean {
    return publication.posts.some((post: any) => {
        const isInactive = channel.isActive === false
        return hasNoCredentials || isStale || isInactive
    })
}
```

### Рекомендации

1. **Для каналов:** ✅ Неактивный канал — это **warning**, не critical
2. **Для публикаций:** ✅ Если публикация содержит пост для неактивного канала — это warning
3. **Для проектов:** ⚠️ Неактивные каналы НЕ должны влиять на статус проекта (т.к. это осознанное решение пользователя)

### Текущие проблемы

В `ProblemsWidget.vue` статистика неактивных каналов не обновляется из API ответа:
```typescript
// TODO: Добавить counting для inactive каналов в stats computation
if (stats.value.channels.inactive > 0) { ... }
```

Нужно убедиться, что в computed `stats` корректно считаются неактивные каналы.

---

## Подсчёт статистики

### Вопрос: Должны ли неактивные каналы учитываться в подсчёте публикаций проекта?

#### Текущее поведение

Посты неактивных каналов **учитываются** в общей статистике, т.к. фильтрация в `channels.service.ts` применяется только на уровне выборки каналов:

```typescript
postsCount: counts.published,
failedPostsCount: counts.failed,
```

#### Рекомендуемое поведение

| Метрика | Учитывать неактивные каналы? |
|---------|------------------------------|
| Общее количество каналов проекта | ❌ Нет (только активные и неархивированные) |
| Количество опубликованных постов канала | ✅ Да (историческая статистика) |
| Количество постов проекта | ✅ Да (историческая статистика) |
| Количество ошибок канала | ✅ Да (для диагностики проблем) |
| Счётчик активных каналов на Dashboard | ❌ Нет |

**Обоснование:** Деактивация канала — это временная мера. Историческая статистика не должна теряться. Однако в контексте "сколько каналов доступно для публикации" — неактивные исключаются.

---

## Рекомендации

### 1. Документация и UX

- [ ] Добавить tooltip с объяснением разницы между "Неактивен" и "Архивирован"
- [ ] В форме канала добавить описание: "Деактивированные каналы не участвуют в публикации, но остаются видимыми в списках"

### 2. Логика проблем

- [ ] Убедиться, что неактивные каналы отображаются в `ProblemsWidget`
- [ ] Неактивные каналы — это warning, не critical
- [ ] Неактивные каналы НЕ должны влиять на "здоровье" проекта (т.к. это осознанный выбор)

### 3. Выбор каналов для публикации

- [ ] При создании постов для публикации показывать неактивные каналы как disabled с пояснением
- [ ] Не позволять создавать посты для неактивных каналов

### 4. API и бэкенд

- [ ] `SocialPostingService` корректно блокирует публикацию в неактивные каналы ✅
- [ ] При массовой публикации пропускать неактивные каналы с понятной ошибкой ✅

### 5. Статистика Dashboard

- [ ] Количество каналов в Dashboard — только активные и неархивированные ✅
- [ ] Историческая статистика (опубликованные посты) — включает все каналы ✅

---

## Заключение

Концепция неактивных каналов **имеет смысл** и дополняет архивирование. Ключевые различия:

- **Архив** = "больше не нужен" → убрать из виду
- **Неактивен** = "временно на паузе" → держать на виду, но не публиковать

Текущая реализация в целом соответствует этой концепции, но требует небольших доработок в части UX-документации и консистенции отображения в виджете проблем.
