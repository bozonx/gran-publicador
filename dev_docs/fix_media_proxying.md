# План исправления проксирования медиа-файлов

Проблема заключается в некорректной реализации стриминга в связке NestJS + Fastify и потенциальном преждевременном закрытии соединения.

## 1. Рефакторинг `MediaService`
- Изменить алгоритм проксирования: вместо принятия объекта ответа (`res`), методы будут возвращать объект с данными стрима:
  ```typescript
  {
    stream: Readable;
    contentType: string;
    contentLength?: string;
    status: number;
    headers: Record<string, string>;
  }
  ```
- Использовать `pipeline` из `node:stream/promises` или `Readable.fromWeb` для надежной передачи данных.
- Очищать заголовки от "hop-by-hop" (Connection, Transfer-Encoding и т.д.), которые не должны проксироваться.

## 2. Исправление `MediaController`
- Убрать сомнительные значения по умолчанию для `@Res() res: FastifyReply = {} as any`.
- Использовать `res.header()` и `res.send(stream)` (стандартный путь Fastify) для отправки файла. Это позволит Fastify корректно управлять жизненным циклом ответа.
- Убедиться, что все вызовы сервиса дожидаются завершения подготовки стрима.

## 3. Проверка `JwtOrApiTokenGuard`
- Убедиться, что токен из `query` параметров корректно подхватывается для запросов к картинкам.

## 4. Тестирование
- Выполнить `curl` запрос к эндпоинту с валидным токеном и проверить заголовки и целостность тела ответа.
