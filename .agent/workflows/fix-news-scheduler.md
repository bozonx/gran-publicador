---
description: Исправление шедулера уведомлений о новостях
---

## Проблема
1. **Повторные уведомления:** Шедулер может присылать одну и ту же подборку новостей, если порядок сортировки в API по умолчанию — `relevance` (при наличии поискового запроса `q`). В этом случае `items[0]` может быть старой новостью, и установка вотермарка на её дату приводит к тому, что новые новости снова попадают в следующий поиск.
2. **Потеря новостей:** Если за интервал проверки пришло больше 20 новостей (лимит по умолчанию), шедулер обрабатывает только первые 20 (самые новые) и обновляет вотермарк, пропуская остальные.

## Решение
1. **Принудительная сортировка:** Добавить `orderBy: 'savedAt'` в параметры запроса.
2. **Пагинация:** Использовать `cursor` для получения всех новых новостей, если их больше одного батча.
3. **Корректный вотермарк:** Обновлять `lastCheckedAt` и `lastId` по абсолютно самому новому элементу из всех полученных.

## План действий
1. Модифицировать `processQuery` в `src/modules/news-queries/news-notifications.scheduler.ts`:
   - Добавить цикл `while` для получения всех страниц новостей через `cursor`.
   - Накапливать все новости в одном массиве.
   - Явно передавать `orderBy: 'savedAt'`.
   - После сбора всех новостей, отправлять уведомление и обновлять состояние базы данных самым современным таймстампом.
